---
title: 鸿蒙-做一个简版的富文本解析控件
tags: [HarmonyOS]
date: 2024-10-17 21:30:03
keywords: HarmonyOS,鸿蒙应用开发,鸿蒙手机应用开发,XmlPullParser,Html解析,Html展示
---
本来只是需要展示一下简单的富文本，支持简单的背景色，字体大小，字体颜色就够了。调研了一圈都没有完全符合需求的。那就自己撸一个呗。
支持 span、font、br、a标签就好，属性的话就支持color、font-color、size、font-size、background、href这些属性就好了。

<!--more-->
老规矩，先上效果图

<img src='/image/HarmonyOS/html_parse_render.png' width='30%' heigh='30%'/>
最上面是富文本，中间是自己撸的控件，最下面是鸿蒙自带的RichText。
看起来还行，主要是自己写的，调整起来也方便

## 限制

1. 目前只支持了上面说的那些标签级属性：span、font、br、a标签 和 color、font-color、size、font-size、background、href这些属性
2. 富文本的解析使用的是`xml.XmlPullParser`,因此对富文本内容中的标签要求比较严格，一定要严格闭合才行，否则解析会失败。
3. 也要求所有元素都必须包含在标签内容，否则也会失败，应对这个问题，可以通过在富文本最外层添加没有属性的span标签解决
4. 对于颜色值，只支持了有限了英文名字，建议使用十六进制表示

## 结果展示

解析结果的展示是`Text`中嵌套`Span`和`ContainerSpan`实现的,限制也来源于此：
1. `Span`不支持背景色，要么只能依赖父级控件`Text`或者`ContainerSpan`来设置背景色
2. `ContainerSpan`只能包含`Span`、`ImageSpan`子组件。
3. `Span`、`ImageSpan` 没有子控件

也就是说解析结果只有一个`Text`控件，内容样式都由`Span`和`ContainerSpan`完成

## 思路

展示结果使用`Text`嵌套`Span`和`ContainerSpan`实现,将样式抽成一个类，要展示的文字作为属性就好了。
``` TypeScript
export class VNode{
  text:string=''
  child?:VNode[]=[]
  style:Style= new Style()
}

/**
 * 属性默认值都可以做成配置，由调用者传入
 */
export class Style{
  //如果有backGround属性需要使用 ContainerSpan
  backgroundColor:string|Resource|Color=Color.Transparent
  //文字默认大小，可以做成参数由使用者穿进来
  fontSize:number = 16
  fontColor:string|Resource|Color = Color.Black
  hrefFontColor:string|Resource|Color = Color.Blue
  href:string | undefined
}
```

子控件需要继承父控件的属性，当子控件解析完成后，我们需要恢复父控件的属性，很自然的想到使用`Stack`来保存每一层级的属性，遇到开始标签则复制一份父控件的样式属性(栈顶元素)然后入栈。遇到结束标签则出栈。注意下`br`标签，只是换行，不会有样式，直接添加一个`Span('\n')`就行。
