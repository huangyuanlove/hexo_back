---
title: 使用无障碍服务完成一键拨打微信视频电话
tags: [Android]
date: 2024-08-16 10:10:35
keywords: 无障碍服务,AccessibilityService,一键拨打微信电话
---

无障碍服务适配大家应该多多少少的都遇到过，简单点讲就是给图片、文本等控件加上 `android:contentDescription=""`标签，这样在使用无障碍服务(比如手机自带的 talkback)时，可以将`contentDescription`的内容以声音的方式读出来，方便视障用户使用我们的 app。

这不是本文的重点，重点是在无障碍-->已安装的服务中中发现了一些其他的应用也提供了一些无障碍服务，比如某输入法提供了"智能回复"、"智能应答"等服务，某些应用还提供了类似于一键进行微信视频通话功能，这玩意咋搞的？我们能不能搞？能不能给老人做一个简单的工具，去掉那些花里胡哨的功能，点个按钮就能和我们进行视频通话？
<!--more-->

查了一些资料，我们可以使用`AccessibilityService`来实现该功能。该服务可以在页面切换或者发生其他变化时回调某些方法，我们可以根据这些回调，获取到页面的节点(控件)信息，来进行点击、长按等操作。

## 第一步：创建与配置

我们需要自定义一个继承自`AccessibilityService`的 service，然后在`AndroidManifest.xml`文件中注册一下，就想普通的 service 差不多，这里有三个可以被重写方法
``` kotlin
import android.accessibilityservice.AccessibilityService;
import android.view.accessibility.AccessibilityEvent;

public class MyAccessibilityService extends AccessibilityService {

    @Override
    public void onAccessibilityEvent(AccessibilityEvent event) {
        // 处理接收到的辅助功能事件
    }

    @Override
    public void onInterrupt() {
        // 处理服务被中断的情况
    }

    @Override
    protected void onServiceConnected() {
        super.onServiceConnected();
        // 初始化服务
    }
}
```
在清单文件中注册一下
``` xml
<service
    android:name=".MyAccessibilityService"
    android:permission="android.permission.BIND_ACCESSIBILITY_SERVICE">
    <intent-filter>
        <action android:name="android.accessibilityservice.AccessibilityService" />
    </intent-filter>

    <meta-data
        android:name="android.accessibilityservice"
        android:resource="@xml/accessibility_service_config" />
</service>
```
需要注意这里的`meta-data`标签，其中的`name`属性值是固定的，`resource`属性则是我们为无障碍服务提供的配置文件。大致有这么一些属性
`accessibility_service_config.xml` 是一个用于配置 `AccessibilityService` 的 XML 文件，其中包含了许多属性，用于定义服务的行为和特性。以下是这些属性的详细介绍和示例说明：

### 1. `android:description`
描述服务的用途，通常是一个字符串资源的引用。这个值会展示在开启无障碍服务时的帮助说明中



### 2. `android:accessibilityEventTypes`
定义服务要监听的事件类型。可以是以下之一或多个的组合：
- `typeAllMask`
- `typeViewClicked`
- `typeViewFocused`
- `typeViewLongClicked`
- `typeViewSelected`
- `typeViewTextChanged`
- `typeWindowContentChanged`
- `typeWindowStateChanged`。

这里我们只需要监听 `typeWindowContentChanged` 和 `typeWindowStateChanged` 就足够了

### 3. `android:packageNames`
指定服务要监听的应用包名。多个包名可以用逗号分隔。这个没啥好说的

### 4. `android:accessibilityFeedbackType`
定义服务的反馈类型，就是如何给用户反馈，可以是以下之一或多个的组合：
- `feedbackSpoken` ： 适用于需要将信息通过语音读出来的情况，例如屏幕阅读器。
- `feedbackHaptic` ： 适用于需要通过振动提醒用户的情况，例如通知用户某个操作成功或失败。
- `feedbackAudible` ： 适用于需要通过音效提醒用户的情况，例如提示音。
- `feedbackVisual` ： 适用于需要通过视觉效果（如闪烁、颜色变化）提醒用户的情况。
- `feedbackGeneric` ： 适用于不特定于某一种反馈类型的情况。
- `feedbackBraille` : 适用于需要将信息传递给盲文设备用户的情况。



### 5. `android:notificationTimeout`
定义服务在处理连续事件之间的最短时间间隔，以毫秒为单位。当辅助功能服务接收到大量的连续事件时，可能会导致性能问题或用户体验不佳。通过设置 `notificationTimeout`，可以指定一个时间窗口，在这个时间窗口内重复的事件将被合并为一个事件，从而减少处理的频率。



### 6. `android:canRetrieveWindowContent`
定义服务是否可以检索窗口内容。设置为 `true` 表示服务可以访问窗口内容。


### 7. `android:settingsActivity`
指定一个设置活动的类名，用户可以通过辅助功能设置页面进入该活动。配置了该属性之后，用户可以在开启无障碍服务页面点击更多设置直接进入到该页面


### 8. `android:canRequestTouchExplorationMode`
属性用于指定辅助功能服务是否可以请求触摸探索模式。触摸探索模式是一种特殊的输入模式，通常用于帮助视力障碍用户使用触摸屏设备
这里也需要我们在代码中设置一下
``` kotlin
override fun onServiceConnected() {
    super.onServiceConnected()
    val info = AccessibilityServiceInfo()
    info.flags = AccessibilityServiceInfo.FLAG_REQUEST_TOUCH_EXPLORATION_MODE
    serviceInfo = info
}
```
并且，在处理事件中我们也需要处理更多的事件
>启用时：应用需要处理更多的辅助功能事件，如 TYPE_TOUCH_EXPLORATION_GESTURE_START 和 TYPE_TOUCH_EXPLORATION_GESTURE_END。这些事件帮助应用确定用户正在进行触摸探索。
>未启用时：应用只需处理标准的触摸事件。


### 9. `android:canRequestEnhancedWebAccessibility`
定义服务是否可以请求增强的网页辅助功能。

### 10. `android:canRequestFilterKeyEvents`
用于指定辅助功能服务是否可以请求过滤键事件（key events）。这对于开发辅助功能服务（如屏幕阅读器或其他辅助工具）非常重要，因为它允许这些服务拦截和处理按键事件，以提供更好的用户体验和辅助功能支持。同样的，不仅要在配置文件中声明，也需要在代码中设置
``` kotlin
override fun onServiceConnected() {
    super.onServiceConnected()
    val info = AccessibilityServiceInfo()
    info.flags = AccessibilityServiceInfo.FLAG_REQUEST_FILTER_KEY_EVENTS
    serviceInfo = info
}
```


### 11. `android:canPerformGestures`
定义服务是否可以执行手势。如果为 true，我们可以这样执行手势
``` kotlin
// 执行点击手势
private void performClick(float x, float y) {
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {
        Path clickPath = new Path();
        clickPath.moveTo(x, y);
        GestureDescription.StrokeDescription clickStroke = new GestureDescription.StrokeDescription(clickPath, 0, 100);
        GestureDescription gestureDescription = new GestureDescription.Builder().addStroke(clickStroke).build();
        dispatchGesture(gestureDescription, null, null);
    }
}
```

### 12. `android:accessibilityFlags`
定义服务的辅助功能标志，这些标志定义了服务的行为和特性。通过设置不同的标志，开发者可以控制辅助功能服务如何与系统和应用交互。可以是以下之一或多个的组合：

1. **`flagIncludeNotImportantViews`**：
    - **作用**：包括那些通常被认为不重要的视图（如布局视图）在辅助功能事件中。
    - **使用场景**：当需要确保所有视图都被辅助功能服务处理时使用。

2. **`flagRequestTouchExplorationMode`**：
    - **作用**：请求触摸探索模式，这对于视力障碍用户非常有用。
    - **使用场景**：当辅助功能服务需要解释触摸事件并提供反馈时使用。

3. **`flagReportViewIds`**：
    - **作用**：报告视图的资源 ID。
    - **使用场景**：当辅助功能服务需要识别和操作特定视图时使用。

4. **`flagRetrieveInteractiveWindows`**：
    - **作用**：允许辅助功能服务检索交互窗口。
    - **使用场景**：当需要处理多个窗口或弹出窗口时使用。



当然我们也可以在代码中设置标志

在你的 `AccessibilityService` 中，你可以使用 `AccessibilityServiceInfo` 来设置标志：

``` kotlin
    override fun onServiceConnected() {
        super.onServiceConnected()
        val info = AccessibilityServiceInfo()
        info.flags = (AccessibilityServiceInfo.FLAG_INCLUDE_NOT_IMPORTANT_VIEWS
                or AccessibilityServiceInfo.FLAG_REPORT_VIEW_IDS
                or AccessibilityServiceInfo.FLAG_RETRIEVE_INTERACTIVE_WINDOWS)
        serviceInfo = info
    }
```


### 示例完整配置文件

下面是我们这次需要用到的配置文件内容：

```xml
<?xml version="1.0" encoding="utf-8"?>
<accessibility-service
    xmlns:android="http://schemas.android.com/apk/res/android"
    android:accessibilityEventTypes="typeWindowContentChanged|typeWindowStateChanged"
    android:accessibilityFeedbackType="feedbackGeneric"
    android:accessibilityFlags="flagIncludeNotImportantViews|flagReportViewIds"
    android:canRetrieveWindowContent="true"
    android:canRequestTouchExplorationMode="true"
    android:canRequestFilterKeyEvents="true"
    android:canPerformGestures="true"
    android:packageNames="com.tencent.mm"
    android:settingsActivity="com.huangyuanlove.auxiliary.SettingActivity"
    android:description="@string/wx_make_call_service_helper"
    android:notificationTimeout="100"/>
```

通过配置这些属性，你可以精确地控制 `AccessibilityService` 的行为，以满足特定的需求和用例。

## 第二步：rua代码

在上面我们已经做好了基础配置，下面开始rua 代码，看看我们应该怎么做。

### 分析路径流程

我们先做好微信的前期准备工作：通话双方是好友、微信已经登录。
那么我们的使用流程大致时这样的：
打开微信
点击底部通讯录
找到这个好友(可能需要滑动通讯录列表)点击一下进入到好友信息页面
点击信息页面的音视频通话
在底部弹窗中点击视频通话或者语音通话